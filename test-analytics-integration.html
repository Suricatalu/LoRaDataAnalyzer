<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Integration Test - Gateway Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background: #121212; 
            color: #fff; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
        }
        .chart-container { 
            width: 600px; 
            height: 400px; 
            margin: 20px auto; 
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
        }
        .info-panel {
            background: #2a2a2a;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>Analytics Integration Test - Gateway Chart</h1>
    
    <div class="info-panel">
        <h3>測試步驟：</h3>
        <ol>
            <li>模擬 analytics 數據結構</li>
            <li>設置 window.getCurrentAnalytics()</li>
            <li>測試 createNodeGwPolarChart 使用新的數據結構</li>
            <li>測試 updateNodeGwPolarChart 使用新的數據結構</li>
        </ol>
        <div id="debugInfo"></div>
    </div>
    
    <div style="text-align: center;">
        <button onclick="testAnalyticsIntegration()">測試 Analytics 整合</button>
        <button onclick="testRawDataFallback()">測試原始數據回退</button>
        <button onclick="testChartUpdate()">測試圖表更新</button>
    </div>
    
    <div class="chart-container">
        <canvas id="nodeGwPolarChart"></canvas>
    </div>
    
    <!-- Include chart manager -->
    <script src="assets/chart-manager.js"></script>
    
    <script>
        // 模擬 analytics 數據結構
        const mockAnalytics = {
            perNode: [
                {
                    id: { 
                        devName: "TestNode1", 
                        devAddr: "12345678" 
                    },
                    total: {
                        totalWithDuplicates: 120,
                        gatewayCounts: {
                            "0016C001F1DE40D9ABCDEF12": 45,
                            "0016C001F1DE40D9FEDCBA98": 32, 
                            "GW-C": 28,
                            "GW-D-LONGNAME123456": 15
                        },
                        gatewaysUsed: [
                            "0016C001F1DE40D9ABCDEF12",
                            "0016C001F1DE40D9FEDCBA98", 
                            "GW-C",
                            "GW-D-LONGNAME123456"
                        ]
                    }
                },
                {
                    id: { 
                        devName: "TestNode2", 
                        devAddr: "87654321" 
                    },
                    total: {
                        totalWithDuplicates: 85,
                        gatewayCounts: {
                            "0016C001F1DE40D9ABCDEF12": 50,
                            "GW-C": 35
                        },
                        gatewaysUsed: [
                            "0016C001F1DE40D9ABCDEF12",
                            "GW-C"
                        ]
                    }
                }
            ],
            global: {
                total: {
                    gatewaysUsed: [
                        "0016C001F1DE40D9ABCDEF12",
                        "0016C001F1DE40D9FEDCBA98", 
                        "GW-C",
                        "GW-D-LONGNAME123456"
                    ]
                }
            }
        };
        
        // 模擬原始數據
        const mockRawRecords = [
            {
                Devname: "TestNode1",
                Devaddr: "12345678",
                Mac: "0016C001F1DE40D9ABCDEF12\n0016C001F1DE40D9FEDCBA98",
                Fcnt: 1001
            },
            {
                Devname: "TestNode1", 
                Devaddr: "12345678",
                Mac: "GW-C",
                Fcnt: 1002
            }
        ];
        
        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        function testAnalyticsIntegration() {
            updateDebugInfo('開始測試 Analytics 整合...');
            
            // 設置 mock getCurrentAnalytics
            window.getCurrentAnalytics = () => {
                updateDebugInfo('getCurrentAnalytics() 被調用');
                return mockAnalytics;
            };
            
            // 清除 getRawRecords 以確保使用 analytics 路徑
            delete window.getRawRecords;
            
            updateDebugInfo('創建圖表（使用 Analytics 數據）...');
            if (window.createNodeGwPolarChart) {
                window.createNodeGwPolarChart("TestNode1", "12345678");
                updateDebugInfo('圖表創建完成');
            } else {
                updateDebugInfo('錯誤：createNodeGwPolarChart 函數不存在');
            }
        }
        
        function testRawDataFallback() {
            updateDebugInfo('開始測試原始數據回退...');
            
            // 清除 getCurrentAnalytics 以觸發回退
            delete window.getCurrentAnalytics;
            
            // 設置 mock getRawRecords
            window.getRawRecords = () => {
                updateDebugInfo('getRawRecords() 被調用（回退模式）');
                return mockRawRecords;
            };
            
            updateDebugInfo('創建圖表（使用原始數據回退）...');
            if (window.createNodeGwPolarChart) {
                window.createNodeGwPolarChart("TestNode1", "12345678");
                updateDebugInfo('圖表創建完成（回退模式）');
            } else {
                updateDebugInfo('錯誤：createNodeGwPolarChart 函數不存在');
            }
        }
        
        function testChartUpdate() {
            updateDebugInfo('開始測試圖表更新...');
            
            // 恢復 getCurrentAnalytics
            window.getCurrentAnalytics = () => {
                updateDebugInfo('更新時 getCurrentAnalytics() 被調用');
                // 返回修改過的數據以測試更新
                const updatedAnalytics = JSON.parse(JSON.stringify(mockAnalytics));
                updatedAnalytics.perNode[0].total.gatewayCounts["NEW-GATEWAY"] = 25;
                updatedAnalytics.perNode[0].total.totalWithDuplicates = 145;
                return updatedAnalytics;
            };
            
            updateDebugInfo('更新圖表...');
            if (window.updateNodeGwPolarChart) {
                window.updateNodeGwPolarChart("TestNode1", "12345678");
                updateDebugInfo('圖表更新完成');
            } else {
                updateDebugInfo('錯誤：updateNodeGwPolarChart 函數不存在');
            }
        }
        
        // 初始化
        updateDebugInfo('頁面載入完成，準備測試...');
        updateDebugInfo('可用函數：' + (window.createNodeGwPolarChart ? '✓ createNodeGwPolarChart' : '✗ createNodeGwPolarChart') + 
                                   ', ' + (window.updateNodeGwPolarChart ? '✓ updateNodeGwPolarChart' : '✗ updateNodeGwPolarChart'));
    </script>
</body>
</html>
