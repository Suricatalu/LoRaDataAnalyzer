<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WISE-6610 Data Analyzer</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <!-- Modular JavaScript files -->
    <script src="assets/data-processor-analytics.js"></script>
    <script src="assets/data-processor-raw.js"></script>
    <!-- LoRa payload parsers -->
    <script src="assets/wise-parser-api.js"></script>
    <script src="assets/eva-parser-api.js"></script>
    <script src="assets/lora-data-parser.js"></script>
    <script src="assets/chart-manager.js"></script>
    <script src="assets/table-manager.js"></script>
    <script src="assets/app-controller.js"></script>
</head>
<body>
    <h1>WISE6610 Data Analyzer</h1>
    

    <!-- Adjusted layout for sectors -->
    <div class="main-layout">
        <div class="left-panel">
            <section id="file-upload">
                <h2>History Records File Upload</h2>
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">
                            <div class="upload-title">Drag & Drop File</div>
                            <div class="upload-subtitle">or click here to select a file</div>
                        </div>
                        <span class="help-icon upload-help" data-tip="Upload the exported CSV data from WISE-6610 V2. The file will be parsed locally in your browser.">?</span>
                        <div class="upload-formats">Format: .csv</div>
                    </div>
                    <input type="file" id="csvFile" accept=".csv" hidden />
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                        <button class="remove-file-btn" id="removeFileBtn">‚úï</button>
                    </div>
                </div>
            </section>
            <section id="settings">
                <h2>Settings</h2>
                <div class="settings-container">
                    <!-- Start DateTime -->
                    <h3>Time Settings</h3>
                    <div class="setting-row">
                        <label class="setting-label">Start DateTime
                            <span class="help-icon" data-tip="Only include records AFTER this date & time.">?</span>
                        </label>
                        <input type="datetime-local" id="startDate" />
                    </div>

                    <!-- End DateTime -->
                    <div class="setting-row">
                        <label class="setting-label">End DateTime
                            <span class="help-icon" data-tip="Only include records BEFORE this date & time.">?</span>
                        </label>
                        <input type="datetime-local" id="endDate" />
                    </div>
                    <!-- Timezone Selector -->
                    <div class="setting-row">
                        <label class="setting-label">Timezone
                            <span class="help-icon" data-tip="Used to parse and analyze the data via the timezone. Defaults to your browser detected timezone. Manually change when the user is from a different timezone. This selection will NOT change automatically after CSV upload.">?</span>
                        </label>
                        <div class="tz-select-wrapper" id="timezoneCustomWrapper">
                            <button type="button" id="timezoneSelectButton" class="tz-select-btn" aria-haspopup="listbox" aria-expanded="false">Loading...</button>
                            <div id="timezoneOptions" class="tz-options" role="listbox" aria-label="Timezone Options"></div>
                            <!-- Keep original select for existing JS logic -->
                            <select id="timezoneSelect" class="visually-hidden" tabindex="-1" aria-hidden="true"></select>
                        </div>
                    </div>
                    

                    <!-- Divider -->
                    <div class="settings-divider" aria-hidden="true"></div>

                    <!-- Basic Factor -->
                    <h3>Basic Factor (Normal/Abnormal)</h3>
                    <div class="setting-row">
                        <label for="threshold" class="setting-label">Loss Rate Threshold (%)
                            <span class="help-icon" data-tip="Highlight / analyze nodes whose packet loss rate exceeds or equals this threshold">?</span>
                        </label>
                        <input type="number" id="threshold" value="0" min="0" max="100" step="5" />
                    </div>

                    <!-- Divider -->
                    <div class="settings-divider" aria-hidden="true"></div>

                    <!-- FCNT Issue (checkbox inside label, on left) -->
                    <h3>Optional Factor (Exception)</h3>
                    <div class="setting-row">
                        <label class="setting-label"><input type="checkbox" id="useFcntIssue" class="include-flag" /> FCNT Drop / Reset Issue
                            <span class="ex-badge rst" title="FCNT Reset / Drop">RST</span>
                            <span class="help-icon" data-tip="Enable to only include nodes that had frame counter drop or reset events, which usually represent a restart behavior of node.">?</span>
                        </label>
                        <input type="number" id="fcntrIssueThreshold" min="0" value="1" step="1" placeholder="e.g. 1" />
                    </div>
                    
                    <!-- Inactive Since (overall end vs node last upload) -->
                    <div class="setting-row">
                        <label class="setting-label"><input type="checkbox" id="useInactiveSince" class="include-flag" /> Inactive Since (minutes)
                            <span class="ex-badge inact" title="Inactive Since">INACT</span>
                            <span class="help-icon" data-tip="Mark nodes whose last upload till the overall last timestamp exceeds this number of minutes when enabled , which represents a period of inactivity of node.">?</span>
                        </label>
                        <input type="number" id="inactiveSinceMinutes" min="0" value="90" step="1" placeholder="e.g. 90" />
                    </div>
                    
                    <!-- Divider between Exception and Advanced Analysis -->
                    <div class="settings-divider" aria-hidden="true"></div>

                    <!-- Advanced Analysis Section -->
                    <h3>Advanced Analysis</h3>
                    <div class="setting-row">
                        <label class="setting-label"><input type="checkbox" id="useNoDataDuration" class="include-flag" /> No Data Gap (minutes)
                            <span class="help-icon" data-tip="Analyze nodes that had no data for a continuous gap longer than this number of minutes. (Advanced only, not classified as Exception)">?</span>
                        </label>
                        <input type="number" id="noDataDuration" min="0" value="90" step="1" placeholder="e.g. 90" />
                    </div>
                </div>
            </section>
        </div>
        <div class="right-panel">
            <!-- Sector 1: Bar Chart -->
            <section id="sector1">
                <h2>Statistics Bar Chart</h2>
                <div class='chart-container'><canvas id='barChart'></canvas></div>
            </section>
            <!-- Sector 2: Detail Table -->
            <section id="sector2">
                <h2 style="text-align: center;">Node Statistics Table</h2>
                <div class="table-controls">
                    <button id="showAllNodesBtn" class="control-button">
                        Show All
                    </button>
                </div>
                <table id="detailTable" class="display nowrap cell-border">
                <!-- <thead>
                    <tr>
                    <th>Devname</th>
                    <th>Devaddr</th>
                    <th>Loss Rate (%)</th>
                    <th>Avg RSSI</th>
                    <th>Avg SNR</th>
                    <th>First Uplink Time</th>
                    <th>Last Uplink Time</th>
                    <th>Duplicate Count</th>
                    <th>Total Uplink Count</th>
                    <th>FCNT Reset Count</th>
                    <th>Used Data Rate</th>    
                    </tr>
                </thead>
                <tbody>
                </tbody> -->
                </table>
            </section>
        </div>
    </div>

    <!-- Overlay for Node Details -->
    <div id="nodeOverlay" class="overlay hidden">
        <div class="overlay-content">
            <h2 id="overlayTitle"></h2>
            <p id="overlayTimeRange" style="font-size: 13px; color: #888; margin: 5px 0 15px 0;"></p>
            <div class="tabs">
                <button class="tab-button active" data-tab="basicInfo">Âü∫Êú¨Ë≥áË®ä</button>
                <button class="tab-button" data-tab="nodeSignalChart">RSSI & SNR Chart</button>
                <button class="tab-button" data-tab="nodeUpFreqChart">Uplink Freq Chart</button>
                <button class="tab-button" data-tab="nodeGwChart">GW Chart</button>
                <button class="tab-button" data-tab="nodeParsedChart">Payload Parser</button>
                <button class="tab-button" data-tab="nodeData">Node Ë≥áÊñô</button>
                <button class="tab-button" data-tab="nodeGapChart">Gaps</button>
            </div>
            <div class="tab-content hidden" id="nodeParsedChart">
                <!-- Node Parsed Data Chart Content -->
                <div class="node-charts-container">
                    <div class="chart-header">
                        <p class="chart-description">Ëß£ÊûêÈÅ∏ÂÆöÁØÄÈªûÊØèÁ≠ÜË≥áÊñôÁöÑ Payload ‰∏¶Áπ™Ë£ΩÊôÇÈñìÂ∫èÂàóÂúñÔºàx=ÊôÇÈñìÔºåy=Ëß£ÊûêÂÄºÔºâ</p>
                        <div class="parser-controls" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0 2px 0;">
                            <label style="font-size:12px; color:#ddd; display:flex; align-items:center; gap:6px;">
                                Parser:
                                <select id="payloadParserType" style="padding:4px 8px; background:#1e1e1e; color:#fff; border:1px solid #444; border-radius:4px;">
                                    <option value="">None</option>
                                    <option value="wise">WISE</option>
                                    <option value="eva">EVA</option>
                                </select>
                            </label>
                            <label style="font-size:12px; color:#ddd; display:flex; align-items:center; gap:6px; min-width:360px; flex:1;">
                                JSON Ë∑ØÂæë:
                                <input id="payloadParserJsonPath" type="text" placeholder="‰æãÂ¶ÇÔºötemperature Êàñ message.Temp Êàñ data.temperatureC" style="flex:1; padding:6px 10px; background:#1e1e1e; color:#fff; border:1px solid #444; border-radius:4px;" />
                            </label>
                            <label style="font-size:12px; color:#ddd; display:flex; align-items:center; gap:6px; min-width:300px; flex:1;">
                                JSON Ë∑ØÂæë2:
                                <input id="payloadParserJsonPath2" type="text" placeholder="ÂèØÈÅ∏ÔºöÁ¨¨‰∫åÊ¢ùË∑ØÂæë" style="flex:1; padding:6px 10px; background:#1e1e1e; color:#fff; border:1px solid #444; border-radius:4px;" />
                            </label>
                            <label style="font-size:12px; color:#ddd; display:flex; align-items:center; gap:6px; min-width:300px; flex:1;">
                                JSON Ë∑ØÂæë3:
                                <input id="payloadParserJsonPath3" type="text" placeholder="ÂèØÈÅ∏ÔºöÁ¨¨‰∏âÊ¢ùË∑ØÂæë" style="flex:1; padding:6px 10px; background:#1e1e1e; color:#fff; border:1px solid #444; border-radius:4px;" />
                            </label>
                            <span id="payloadParserStatus" style="font-size:12px; color:#aaa;"></span>
                        </div>
                        <div id="payloadParserError" style="font-size:12px; color:#ff8a8a; margin-top:4px; display:none;"></div>
                    </div>
                    <div class="node-chart-wrapper">
                        <canvas id="nodeParsedDataChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="basicInfo">
                <!-- Basic Info Content -->
                <div id="basicInfoContent" style="padding: 20px;">
                    <div class="basic-info-grid">
                        <div class="info-section">
                            <h3>Ë®≠ÂÇôË≥áË®ä</h3>
                            <div class="info-item">
                                <span class="label">Ë®≠ÂÇôÂêçÁ®±:</span>
                                <span id="basicDevname">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Ë®≠ÂÇôÂú∞ÂùÄ:</span>
                                <span id="basicDevaddr">-</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h3>‰ø°ËôüÂìÅË≥™</h3>
                            <div class="info-item">
                                <span class="label">Âπ≥Âùá RSSI:</span>
                                <span id="basicAvgRSSI">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Âπ≥Âùá SNR:</span>
                                <span id="basicAvgSNR">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ÈÅ∫Â§±Áéá:</span>
                                <span id="basicLossRate">-</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h3>Ë≥áÊñôÁµ±Ë®à</h3>
                            <div class="info-item">
                                <span class="label">Á∏ΩÂ∞ÅÂåÖÊï∏:</span>
                                <span id="basicTotalPackets">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ÈáçË§áÂ∞ÅÂåÖÊï∏:</span>
                                <span id="basicDuplicatePackets">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">FCNT ÈáçÁΩÆÊ¨°Êï∏:</span>
                                <span id="basicResetCount">-</span>
                            </div>
                        </div>
                        
                        <div class="info-section time-range-section">
                            <h3>ÊôÇÈñìÁØÑÂúç</h3>
                            <div class="info-item">
                                <span class="label">È¶ñÊ¨°‰∏äË°åÊôÇÈñì:</span>
                                <span id="basicFirstTime">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ÊúÄÂæå‰∏äË°åÊôÇÈñì:</span>
                                <span id="basicLastTime">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Ë≥áÊñôÁØÑÂúç:</span>
                                <span id="basicTimeRange">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="nodeSignalChart">
                <!-- Node Charts Content -->
                <div class="node-charts-container">
                    <div class="chart-header">
                        <p class="chart-description">È°ØÁ§∫ÈÅ∏ÂÆöÁØÄÈªûÁöÑ RSSI Âíå SNR Èö®ÊôÇÈñìËÆäÂåñË∂®Âã¢</p>
                            <label id="toggleGapOverlayLabel" style="font-size:12px; display:inline-flex; align-items:center; gap:4px; margin-top:6px;">
                                <input type="checkbox" id="toggleGapOverlay" checked /> È°ØÁ§∫ GAP ÂçÄÊÆµ
                            </label>
                    </div>
                    <div class="node-chart-wrapper">
                        <canvas id="nodeTimeSeriesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="nodeGapChart">
                <div class="node-charts-container">
                    <div class="chart-header">
                        <p class="chart-description">ÁØÄÈªûÁÑ°Ë≥áÊñô (Gap) ÂçÄÊÆµËàáÊØèÊó•ÊúÄÂ§ß Gap Áµ±Ë®à</p>
                    </div>
                    <div id="gapSummary" class="gap-summary"></div>
                    <div class="node-chart-wrapper">
                        <canvas id="nodeGapTimelineChart"></canvas>
                    </div>
                    <div class="node-chart-wrapper" style="margin-top:16px;">
                        <canvas id="nodeDailyGapBarChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="nodeUpFreqChart">
                <!-- Node Uplink Frequency Chart Content -->
                <div class="node-charts-container">
                    <div class="chart-header">
                        <p class="chart-description">È°ØÁ§∫ÈÅ∏ÂÆöÁØÄÈªûÁöÑ‰∏äË°åÈ†ªÁéá‰ΩøÁî®ÂàÜÂ∏ÉÁµ±Ë®à</p>
                    </div>
                    <div class="node-chart-wrapper">
                        <canvas id="nodeUpFreqBarChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="nodeGwChart">
                <!-- Node Gateway Chart Content -->
                <div class="node-charts-container">
                    <div class="chart-header">
                        <p class="chart-description">È°ØÁ§∫ÈÅ∏ÂÆöÁØÄÈªûË¢´ÂêÑÂÄãÊé•Êî∂Âô®ÔºàGatewayÔºâÊî∂Âà∞ÁöÑÊ¨°Êï∏ËàáÊâÄÊúâÊé•Êî∂Âô®Êî∂Âà∞ÁöÑÊ¨°Êï∏ÁöÑÂàÜÂ∏É</p>
                    </div>
                    <div class="node-chart-wrapper">
                        <canvas id="nodeGwBarChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="tab-content hidden" id="nodeData">
                <!-- Node Data Table -->
                <div class="table-info-header">
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #aaa;">
                        <strong>Ë™™ÊòéÔºö</strong>‰ª•‰∏ãË≥áÊñôÁÇ∫Ê≠§ÁØÄÈªûË£ùÁΩÆÊØè‰∏ÄÁ≠Ü‰∏äË°åËàá‰∏ãË°åÂ∞ÅÂåÖÁöÑË©≥Á¥∞Ë≥áË®ä„ÄÇ
                    </p>
                </div>
                <table id="nodeDataTable" class="display nowrap cell-border">
                    <thead>
                        <tr>
                            <th>Received</th>
                            <th>Type</th>
                            <th>MAC</th>
                            <th>U/L RSSI</th>
                            <th>U/L SNR</th>
                            <th>FCnt</th>
                            <th>Datarate</th>
                            <th>ACK</th>
                            <th>Port</th>
                            <th>Frequency</th>
                            <th>MAC Command</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>