<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Update Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .test-controls label {
            display: block;
            margin-bottom: 10px;
        }
        .test-controls input, .test-controls button {
            margin-left: 10px;
            padding: 5px 10px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .status {
            padding: 10px;
            background: #333;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Chart Update Mechanism Test</h1>
        
        <div class="status" id="status">
            Status: Initializing...
        </div>
        
        <div class="test-controls">
            <h3>測試控制項目</h3>
            <label>
                Start Date: 
                <input type="datetime-local" id="startDate">
            </label>
            <label>
                End Date: 
                <input type="datetime-local" id="endDate">
            </label>
            <button onclick="updateCharts()">手動更新圖表</button>
            <button onclick="createSampleData()">生成測試資料</button>
        </div>
        
        <div class="chart-container">
            <h3>Gateway Polar Chart</h3>
            <canvas id="nodeGwPolarChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>Frequency Chart</h3>
            <canvas id="nodeUpFreqBarChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 模擬必要的全域函數和資料
        let mockRawRecords = [];
        let mockAnalytics = null;
        
        // 模擬 getRawRecords 函數
        window.getRawRecords = function() {
            // 根據時間範圍篩選資料
            const timeFilter = getTimeRangeFilter();
            if (!timeFilter.start && !timeFilter.end) {
                return mockRawRecords;
            }
            
            return mockRawRecords.filter(record => {
                const recordTime = new Date(record.Time);
                let include = true;
                if (timeFilter.start && recordTime < timeFilter.start) include = false;
                if (timeFilter.end && recordTime > timeFilter.end) include = false;
                return include;
            });
        };
        
        // 模擬 getCurrentAnalytics 函數
        window.getCurrentAnalytics = function() {
            return mockAnalytics;
        };
        
        // 模擬 getTimeRangeFilter 函數
        function getTimeRangeFilter() {
            const startVal = document.getElementById('startDate')?.value;
            const endVal = document.getElementById('endDate')?.value;
            const filter = {};
            if (startVal) filter.start = new Date(startVal);
            if (endVal) filter.end = new Date(endVal);
            return filter;
        }
        window.getTimeRangeFilter = getTimeRangeFilter;
        
        // 生成測試資料
        function createSampleData() {
            const gateways = [
                'gateway-001-very-long-name-test',
                'gateway-002-short',
                'gateway-003-medium-length',
                'gw-004-ultra-super-long-name-for-testing-purposes'
            ];
            
            const frequencies = [923.2, 923.4, 923.6, 923.8];
            const devices = ['test-device-001', 'test-device-002'];
            
            mockRawRecords = [];
            
            // 生成過去 7 天的資料
            const now = new Date();
            for (let day = 0; day < 7; day++) {
                const date = new Date(now);
                date.setDate(date.getDate() - day);
                
                for (let hour = 0; hour < 24; hour += 2) {
                    const recordTime = new Date(date);
                    recordTime.setHours(hour);
                    
                    devices.forEach((device, deviceIndex) => {
                        // 隨機選擇接收的 gateway 數量 (1-3個)
                        const gwCount = Math.floor(Math.random() * 3) + 1;
                        const selectedGateways = [];
                        for (let i = 0; i < gwCount; i++) {
                            const gw = gateways[Math.floor(Math.random() * gateways.length)];
                            if (!selectedGateways.includes(gw)) {
                                selectedGateways.push(gw);
                            }
                        }
                        
                        mockRawRecords.push({
                            Time: recordTime.toISOString(),
                            Devname: device,
                            Devaddr: `addr-${deviceIndex + 1}`,
                            Mac: selectedGateways.join('\n'),
                            Frequency: frequencies[Math.floor(Math.random() * frequencies.length)],
                            Fcnt: Math.floor(Math.random() * 1000) + day * 100 + hour,
                            RSSI: -Math.floor(Math.random() * 50) - 70,
                            SNR: Math.floor(Math.random() * 20) - 10
                        });
                    });
                }
            }
            
            // 模擬 analytics 資料
            mockAnalytics = {
                perNode: devices.map((device, index) => ({
                    id: {
                        devName: device,
                        devAddr: `addr-${index + 1}`
                    },
                    total: {
                        totalWithDuplicates: Math.floor(Math.random() * 200) + 100,
                        frequencyCounts: frequencies.reduce((acc, freq) => {
                            acc[freq.toString()] = Math.floor(Math.random() * 50);
                            return acc;
                        }, {})
                    }
                })),
                global: {
                    total: {
                        frequenciesUsed: frequencies
                    }
                }
            };
            
            updateStatus(`生成了 ${mockRawRecords.length} 筆測試資料`);
            
            // 自動設定時間範圍
            const earliestTime = new Date(Math.min(...mockRawRecords.map(r => new Date(r.Time))));
            const latestTime = new Date(Math.max(...mockRawRecords.map(r => new Date(r.Time))));
            
            document.getElementById('startDate').value = earliestTime.toISOString().slice(0, 16);
            document.getElementById('endDate').value = latestTime.toISOString().slice(0, 16);
        }
        
        function updateCharts() {
            updateStatus('正在更新圖表...');
            
            const testDevice = 'test-device-001';
            const testDeviceAddr = 'addr-1';
            
            if (window.updateNodeGwPolarChart) {
                window.updateNodeGwPolarChart(testDevice, testDeviceAddr);
                updateStatus('Gateway 極座標圖表已更新');
            } else if (window.createNodeGwPolarChart) {
                window.createNodeGwPolarChart(testDevice, testDeviceAddr);
                updateStatus('Gateway 極座標圖表已創建');
            }
            
            if (window.updateNodeUpFreqChart) {
                window.updateNodeUpFreqChart(testDevice, testDeviceAddr);
                updateStatus('頻率圖表已更新');
            } else if (window.createNodeUpFreqChart) {
                window.createNodeUpFreqChart(testDevice, testDeviceAddr);
                updateStatus('頻率圖表已創建');
            }
        }
        
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent = `Status: ${message} (${new Date().toLocaleTimeString()})`;
        }
        
        // 監聽日期變更
        document.getElementById('startDate').addEventListener('input', updateCharts);
        document.getElementById('endDate').addEventListener('input', updateCharts);
        
        // 初始化
        window.addEventListener('load', () => {
            createSampleData();
            setTimeout(updateCharts, 500);
        });
        
        updateStatus('測試頁面已載入');
    </script>
    
    <!-- 載入圖表管理器 -->
    <script src="assets/chart-manager.js"></script>
</body>
</html>
